<!-- TOC -->
  * [1. 背景](#1-背景)
  * [2. 假设一张表是行式存储vs列式存储](#2-假设一张表是行式存储vs列式存储)
  * [3. 列式存储的优势](#3-列式存储的优势)
    * [3.1. 高效的数据压缩](#31-高效的数据压缩)
    * [3.2. 优化的读取性能](#32-优化的读取性能)
    * [3.3. 高效的列级操作](#33-高效的列级操作)
  * [4. mysql也是只支持读某一列啊为什么不快](#4-mysql也是只支持读某一列啊为什么不快)
    * [4.1. 行式存储 vs 列式存储](#41-行式存储-vs-列式存储)
      * [4.1.1. 行式存储（MySQL）](#411-行式存储mysql)
      * [4.1.2. 列式存储（ClickHouse）](#412-列式存储clickhouse)
<!-- TOC -->
## 1. 背景

我还是很想知道为什么列式存储，很适合分析数据。

clickhouse为什么快？

## 2. 假设一张表是行式存储vs列式存储

假设我们有一个销售数据表：

```text
销售ID	产品名	销售数量	销售金额	销售日期
1	产品A	10	100.00	2024-01-01
2	产品B	5	50.00	2024-01-02
3	产品A	7	70.00	2024-01-03
4	产品C	20	200.00	2024-01-04
```

上面一行行去组织的数据，就是`行式存储`。

底层的数据结构是：

```text
Row 1: (1, '产品A', 10, 100.00, '2024-01-01')
Row 2: (2, '产品B', 5, 50.00, '2024-01-02')
```

如果改为`列式存储`，同样一张表，底层的数据结构

```text
Column 1: (1, 2, 3, 4, ...)
Column 2: ('产品A', '产品B', '产品A', '产品C', ...)
Column 3: (10, 5, 7, 20, ...)
Column 4: (100.00, 50.00, 70.00, 200.00, ...)
Column 5: ('2024-01-01', '2024-01-02', '2024-01-03', '2024-01-04', ...)
```

## 3. 列式存储的优势

### 3.1. 高效的数据压缩

* 原因：列式存储将同一列的数据存储在一起，相邻的数据通常具有相似的值。这样可以利用数据的相似性进行高效的压缩。
* 例子：如果一个表有一列存储员工的部门信息，而该列的值只有少数几种（例如“销售”、“工程”、“财务”），这些值的`重复性很高`。列式存储可以对这些重复值进行有效的压缩，从而节省存储空间和提高查询效率。

### 3.2. 优化的读取性能

* 原因：在分析查询中，通常只会涉及表中的一部分列。列式存储可以只读取需要的列，而不必读取整个行的数据。（mysql也是只支持读某一列啊）
* 例子：假设有一个包含数百万行的用户数据表，包括列如用户ID、姓名、年龄、注册时间、购买记录。如果你的查询只需要分析年龄列的数据（例如计算年龄的平均值），列式存储可以只读取年龄列的数据，而不必读取整个行的信息，从而减少I/O操作，提高查询速度。

### 3.3. 高效的列级操作

* 原因：列式存储允许在列级别进行操作，例如`列级别`的聚合、排序、过滤等，这些操作比行级别操作更高效。
* 例子：如果你需要计算每个部门的员工人数，可以直接在`部门列`上进行聚合操作，而无需扫描整个数据表。这种操作在列式存储中执行起来更快，因为所有部门信息集中在一起，可以更快地进行分组和计算。

比如员工表：
```text
Column: employee_id: (1, 2, 3, 4, 5, 6)
Column: name: ('Alice', 'Bob', 'Carol', 'Dave', 'Eve', 'Frank')
Column: department: ('Sales', 'Engineering', 'Sales', 'HR', 'Engineering', 'Sales')
Column: salary: (50000, 60000, 55000, 52000, 65000, 58000)
```
我先拿出：
```text
Column: department: ('Sales', 'Engineering', 'Sales', 'HR', 'Engineering', 'Sales')
```
再去`group by` 和 `count`，I/O操作特别少（不用像mysql一样全表扫出来，再挑选部门列，丢掉其他的列），速度嘎嘎快。


## 4. mysql也是只支持读某一列啊为什么不快

确实，MySQL 也支持读取特定的列，但是列式存储和行式存储的区别在于`底层数据存储和读取机制`的不同，导致它们在特定查询场景下的性能差异。以下是具体的对比，来说明为什么列式存储特别适合分析查询，而行式存储在这些场景下表现不如列式存储高效。

### 4.1. 行式存储 vs 列式存储

#### 4.1.1. 行式存储（MySQL）

存储方式：每一行的数据被存储在一起。例如，对于一张表 sales，数据会按行存储，类似这样：

```text
Row 1: (1, '产品A', 10, 100.00, '2024-01-01')
Row 2: (2, '产品B', 5, 50.00, '2024-01-02')
...
```

* 读取特定列：虽然 SQL 查询语句可以指定只读取某些列，例如 `SELECT sales_amount FROM sales`，但在底层，数据库需要扫描表的所有行以找到这些列的数据。

* I/O 操作：由于数据按行存储，读取特定列时，磁盘需要`读取整行数据`，然后`提取`所需的列，这会导致大量的 I/O 操作。

#### 4.1.2. 列式存储（ClickHouse）

存储方式：每一列的数据被存储在一起。例如，对于同样的表 sales，数据会按列存储，类似这样：

```sql
Column 1: (1, 2, 3, 4, ...)
Column 2: ('产品A', '产品B', '产品A', '产品C', ...)
Column 3: (10, 5, 7, 20, ...)
Column 4: (100.00, 50.00, 70.00, 200.00, ...)
Column 5: ('2024-01-01', '2024-01-02', '2024-01-03', '2024-01-04', ...)
```

* 读取特定列：例如，`SELECT sales_amount FROM sales`，在列式存储中，数据库只需要读取 sales_amount 列的数据。
* I/O 操作：由于数据按列存储，读取特定列时，磁盘`只需要读取对应列的数据`，大大减少了 I/O 操作，尤其是在需要读取大量数据的情况下。
