<!-- TOC -->

* [1. 一次发现自己愚蠢的Impala调优记录](#1-一次发现自己愚蠢的impala调优记录)
    * [1.1. 前言](#11-前言)
    * [1.2. 环境信息](#12-环境信息)
    * [1.3. 调优目标](#13-调优目标)
    * [1.4. 调优过程](#14-调优过程)
        * [1.4.1. 第一步：分析查询](#141-第一步分析查询)
        * [1.4.2. 第二步：优化SQL](#142-第二步优化sql)
            * [1.4.2.1. 优化前的SQL](#1421-优化前的sql)
            * [1.4.2.2. 优化后的SQL](#1422-优化后的sql)
        * [1.4.3. 第三步：配置调整](#143-第三步配置调整)
        * [1.4.4. 第四步：监控和验证](#144-第四步监控和验证)
        * [1.4.5. 调优成果](#145-调优成果)
    * [1.5. 结论](#15-结论)
    * [1.6. 参考资料](#16-参考资料)

<!-- TOC -->

# 1. 一次发现自己愚蠢的Impala调优记录

## 1.1. 前言

在一次数据处理任务中，我们遇到了一些性能瓶颈。经过讨论，决定对Impala进行调优。

感觉好记性不如烂笔头，还是记录一下比较好。

## 1.2. 环境信息

- **集群规模**: 10台节点
- **Impala版本**: 3.4.0
- **数据规模**: 10亿行
- **查询类型**: 复杂的多表JOIN和聚合查询

## 1.3. 调优目标

- **目标**: 将查询时间从30分钟缩短到5分钟以内
- **关键指标**: 查询响应时间、资源利用率

## 1.4. 调优过程

### 1.4.1. 第一步：分析查询

首先，我们对查询进行了分析，发现了以下几个问题：

- 使用了多个嵌套的子查询，导致查询计划复杂
- 数据分布不均匀，导致部分节点负载过高
- 缺少适当的分区和索引

### 1.4.2. 第二步：优化SQL

我们对SQL进行了重写，主要进行了以下修改：

1. **简化子查询**: 将嵌套的子查询拉平，避免复杂的查询计划
2. **使用合适的分区**: 根据查询条件对表进行重新分区
3. **添加索引**: 对经常使用的列添加索引，提升查询效率

#### 1.4.2.1. 优化前的SQL

```sql
SELECT *
FROM (SELECT a.id, b.value
      FROM table_a a
               JOIN table_b b ON a.id = b.id
      WHERE b.date >= '2023-01-01') sub
         JOIN table_c c ON sub.id = c.id
WHERE c.status = 'active';
```

#### 1.4.2.2. 优化后的SQL

```sql
SELECT a.id, b.value, c.status
FROM table_a a
         JOIN table_b b ON a.id = b.id
         JOIN table_c c ON a.id = c.id
WHERE b.date >= '2023-01-01'
  AND c.status = 'active';
```

### 1.4.3. 第三步：配置调整

在对SQL进行优化后，我们还对Impala的配置进行了调整，主要涉及以下几个方面：

1. **内存分配**:
    - 增加`mem_limit`参数，确保查询有足够的内存运行
    - 调整`buffer_pool_limit`，优化内存使用

2. **并行度调整**:
    - 增加`num_nodes`参数，利用更多的节点进行并行计算
    - 调整`mt_dop`参数，提升单节点内的并行度

3. **文件格式**:
    - 将表的存储格式由TextFile改为Parquet，提升读写性能

### 1.4.4. 第四步：监控和验证

在完成上述优化后，我们对查询进行了多次测试，并通过监控工具对系统资源使用情况进行了观察。以下是一些关键的监控指标：

- **CPU使用率**: 从原来的90%下降到70%
- **内存使用率**: 稳定在80%左右
- **查询响应时间**: 从30分钟缩短到4分钟

### 1.4.5. 调优成果

经过这次调优，我们成功将查询时间从30分钟缩短到了4分钟，超出了预期目标。以下是我们总结的一些关键点：

- **SQL优化**: 简化查询，减少不必要的嵌套和子查询
- **合理分区和索引**: 提升查询效率，避免数据倾斜
- **配置调整**: 合理分配资源，提高系统并行度

## 1.5. 结论

这次调优不仅大幅提升了查询性能，还发现一个问题，就是我基础掌握太一般了，一开始开发的时候，就应该把SQL写好的。。太愚蠢了。。

## 1.6. 参考资料

- [Impala调优指南](https://www.cloudera.com/documentation/enterprise/latest/topics/impala_performance.html)
- [SQL优化技巧](https://www.sqlshack.com/sql-query-optimization-tips-and-tricks/)

---
